name: Changelog Generation

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to generate changelog for (e.g., v1.0.0)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  # =============================================================================
  # Generate Changelog
  # =============================================================================
  changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Generating changelog for version: $VERSION"
      
      - name: Generate changelog with git-cliff
        uses: orhun/git-cliff-action@v3
        id: git-cliff
        with:
          config: cliff.toml
          args: --verbose --tag ${{ steps.version.outputs.version }}
        env:
          OUTPUT: CHANGELOG.md
        continue-on-error: true
      
      - name: Create cliff.toml if missing
        if: steps.git-cliff.outcome == 'failure'
        run: |
          cat > cliff.toml << 'EOF'
          [changelog]
          header = """
          # Changelog
          
          All notable changes to AI-OS will be documented in this file.
          
          The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
          and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).
          
          """
          body = """
          {% if version %}\
              ## [{{ version | trim_start_matches(pat="v") }}] - {{ timestamp | date(format="%Y-%m-%d") }}
          {% else %}\
              ## [Unreleased]
          {% endif %}\
          {% for group, commits in commits | group_by(attribute="group") %}
              ### {{ group | upper_first }}
              {% for commit in commits %}
                  - {% if commit.scope %}**{{ commit.scope }}**: {% endif %}{{ commit.message | upper_first }}\
              {% endfor %}
          {% endfor %}\n
          """
          footer = """
          <!-- Generated by git-cliff -->
          """
          trim = true
          
          [git]
          conventional_commits = true
          filter_unconventional = false
          split_commits = false
          commit_parsers = [
              { message = "^feat", group = "‚ú® Features" },
              { message = "^fix", group = "üêõ Bug Fixes" },
              { message = "^doc", group = "üìö Documentation" },
              { message = "^perf", group = "‚ö° Performance" },
              { message = "^refactor", group = "‚ôªÔ∏è Refactor" },
              { message = "^style", group = "üé® Styling" },
              { message = "^test", group = "üß™ Testing" },
              { message = "^chore\\(release\\)", skip = true },
              { message = "^chore\\(deps\\)", skip = true },
              { message = "^chore", group = "üîß Miscellaneous" },
              { message = "^ci", group = "üë∑ CI/CD" },
              { body = ".*security", group = "üîí Security" },
          ]
          protect_breaking_commits = false
          filter_commits = false
          tag_pattern = "v[0-9]*"
          skip_tags = ""
          ignore_tags = ""
          topo_order = false
          sort_commits = "oldest"
          EOF
      
      - name: Retry changelog generation
        if: steps.git-cliff.outcome == 'failure'
        uses: orhun/git-cliff-action@v3
        with:
          config: cliff.toml
          args: --verbose
        env:
          OUTPUT: CHANGELOG.md
      
      - name: Commit changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -f "CHANGELOG.md" ]; then
            git add CHANGELOG.md cliff.toml 2>/dev/null || git add CHANGELOG.md
            
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              git commit -m "docs: update CHANGELOG.md for ${{ steps.version.outputs.version }}"
              git push origin HEAD:main
            fi
          fi
      
      - name: Update release notes
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          body_path: CHANGELOG.md
          append_body: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # Create Release PR (for manual changelog updates)
  # =============================================================================
  create-pr:
    name: Create Changelog PR
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs: changelog
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: update CHANGELOG.md"
          title: "üìù Update Changelog"
          body: |
            This PR updates the CHANGELOG.md file with the latest changes.
            
            Generated automatically by the changelog workflow.
          branch: changelog-update
          delete-branch: true
          labels: documentation,automated
