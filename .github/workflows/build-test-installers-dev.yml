name: Build â†’ Test Installers (DEV)

on:
  push:
    branches:
      - dev
  workflow_dispatch:  # Manual trigger for dev testing
    inputs:
      refresh_lock:
        description: 'Refresh requirements-lock.txt'
        required: false
        default: false
        type: boolean
      test_installers:
        description: 'Run installer tests'
        required: false
        default: true
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SHORT_SHA: ${{ github.sha }}

jobs:
  # =============================================================================
  # Prepare version info
  # =============================================================================
  prepare:
    name: Prepare Build Info
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      short_sha: ${{ steps.version.outputs.short_sha }}
      build_date: ${{ steps.version.outputs.build_date }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract version info
        id: version
        run: |
          VERSION=$(grep -oP 'version\s*=\s*"\K[^"]+' pyproject.toml | head -1)
          SHORT_SHA=${GITHUB_SHA::7}
          BUILD_DATE=$(date +'%Y-%m-%d')
          echo "version=$VERSION-dev" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "ðŸ”§ DEV BUILD | Version: $VERSION-dev | SHA: $SHORT_SHA | Date: $BUILD_DATE"

  # =============================================================================
  # Ubuntu/Debian Package Build & Test
  # =============================================================================
  build-deb:
    name: Build & Test Debian Package
    runs-on: ubuntu-22.04
    needs: prepare
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev
      
      - name: Build .deb package
        run: |
          chmod +x ./installers/_builds/ubuntu/build_deb.sh
          if [ "${{ github.event.inputs.refresh_lock }}" == "true" ]; then
            ./installers/_builds/ubuntu/build_deb.sh --refresh-lock
          else
            ./installers/_builds/ubuntu/build_deb.sh
          fi
      
      - name: Test .deb package structure
        run: |
          echo "ðŸ” Testing .deb package structure..."
          DEB_FILE=$(ls installers/releases/*.deb | head -1)
          
          if [ ! -f "$DEB_FILE" ]; then
            echo "âŒ ERROR: .deb file not found"
            exit 1
          fi
          
          echo "ðŸ“¦ Package: $(basename $DEB_FILE)"
          
          # Check package info
          dpkg-deb --info "$DEB_FILE"
          
          # Check package contents
          echo ""
          echo "ðŸ“‚ Package contents:"
          dpkg-deb --contents "$DEB_FILE"
          
          echo "âœ… .deb package validation passed"
      
      - name: Test installation (silent mode)
        if: github.event.inputs.test_installers != 'false'
        run: |
          echo "ðŸ§ª Testing .deb installation (silent mode)..."
          DEB_FILE=$(ls installers/releases/*.deb | head -1)
          
          echo "ðŸ“¦ Installing package: $(basename $DEB_FILE)"
          
          # Python 3.10+ is already available on Ubuntu 22.04+
          
          # Install the package
          sudo dpkg -i "$DEB_FILE" || true
          
          # Fix any dependency issues
          sudo apt-get install -f -y
          
          # Verify installation
          if dpkg -l | grep -q ai-os; then
            echo "âœ… Package installed successfully"
            
            # Check installed files
            echo ""
            echo "ðŸ“‚ Installed files:"
            dpkg -L ai-os | head -20
            
            # Check for essential directories and files
            if [ -d "/opt/ai-os" ]; then
              echo "âœ… Found: /opt/ai-os directory"
              ls -la /opt/ai-os | head -10
            else
              echo "âŒ ERROR: Missing /opt/ai-os directory"
              exit 1
            fi
            
            if [ -f "/usr/local/bin/aios" ] || [ -L "/usr/local/bin/aios" ]; then
              echo "âœ… Found: /usr/local/bin/aios"
            else
              echo "âš ï¸  WARNING: Missing /usr/local/bin/aios"
            fi
            
            # Try to run aios --version if available
            if command -v aios &> /dev/null; then
              echo ""
              echo "ðŸ” Testing aios command:"
              aios --version || echo "âš ï¸  aios command exists but version check failed"
            fi
            
            # Clean up - remove the package
            echo ""
            echo "ðŸ§¹ Cleaning up test installation..."
            sudo dpkg -r ai-os
            
            echo "âœ… Installation test completed"
          else
            echo "âŒ ERROR: Package installation failed"
            dpkg -l | grep ai-os || echo "Package not found in dpkg list"
            exit 1
          fi
      
      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: AI-OS-${{ needs.prepare.outputs.version }}-ubuntu-${{ needs.prepare.outputs.short_sha }}-DEV
          path: installers/releases/*.deb
          retention-days: 7
          if-no-files-found: error

  # =============================================================================
  # Windows Installer Build & Test
  # =============================================================================
  build-windows:
    name: Build & Test Windows Installer
    runs-on: windows-latest
    needs: prepare
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Inno Setup
        run: |
          # Download Inno Setup 6 with retry logic
          $innoUrls = @(
            "https://jrsoftware.org/download.php/is.exe",
            "https://files.jrsoftware.org/is/6/innosetup-6.3.3.exe"
          )
          $innoInstaller = "$env:TEMP\innosetup.exe"
          $maxRetries = 3
          $downloaded = $false
          
          foreach ($url in $innoUrls) {
            for ($i = 1; $i -le $maxRetries; $i++) {
              try {
                Write-Host "Downloading Inno Setup from $url (attempt $i/$maxRetries)..."
                Invoke-WebRequest -Uri $url -OutFile $innoInstaller -UseBasicParsing -TimeoutSec 30
                $downloaded = $true
                Write-Host "âœ… Download successful"
                break
              } catch {
                Write-Host "âš ï¸  Download failed: $($_.Exception.Message)"
                if ($i -lt $maxRetries) {
                  Start-Sleep -Seconds 5
                }
              }
            }
            if ($downloaded) { break }
          }
          
          if (-not $downloaded) {
            Write-Error "Failed to download Inno Setup from all sources"
            exit 1
          }
          
          Write-Host "Installing Inno Setup silently..."
          Start-Process -FilePath $innoInstaller -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/SP-" -Wait
          
          # Add to PATH for this session
          $innoPath = "C:\Program Files (x86)\Inno Setup 6"
          echo "$innoPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
          Write-Host "âœ… Inno Setup installed successfully"
        shell: pwsh
      
      - name: Build Windows installer
        run: |
          & .\installers\_builds\windows\build_windows_installer.ps1
        shell: pwsh
      
      - name: Test installer structure
        run: |
          Write-Host "ðŸ” Testing Windows installer structure..."
          
          $installerFile = Get-ChildItem -Path "installers\releases\*.exe" | Select-Object -First 1
          
          if (-not $installerFile) {
            Write-Host "âŒ ERROR: Installer file not found"
            exit 1
          }
          
          Write-Host "ðŸ“¦ Installer: $($installerFile.Name)"
          Write-Host "ðŸ“Š Size: $([math]::Round($installerFile.Length / 1MB, 2)) MB"
          
          # Check if file is a valid PE executable
          $fileHeader = [System.IO.File]::ReadAllBytes($installerFile.FullName)[0..1]
          if ($fileHeader[0] -eq 0x4D -and $fileHeader[1] -eq 0x5A) {
            Write-Host "âœ… Valid Windows executable (PE format)"
          } else {
            Write-Host "âŒ ERROR: Not a valid Windows executable"
            exit 1
          }
          
          Write-Host "âœ… Installer validation passed"
        shell: pwsh
      
      - name: Test installation (silent mode)
        if: github.event.inputs.test_installers != 'false'
        run: |
          Write-Host "ðŸ§ª Testing Windows installation (silent mode)..."
          
          # Check if running as admin
          $isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
          Write-Host "ðŸ” Running as admin: $isAdmin"
          
          $installerFile = Get-ChildItem -Path "installers\releases\*.exe" | Select-Object -First 1
          $testInstallDir = "$env:TEMP\AI-OS-Test-$([guid]::NewGuid().ToString().Substring(0,8))"
          $logFile = "$env:TEMP\aios-install-test.log"
          
          Write-Host "ðŸ“¦ Installer: $($installerFile.Name)"
          Write-Host "ðŸ“‚ Test installation directory: $testInstallDir"
          
          # Run installer in silent mode with custom directory
          # GitHub Actions runners run with admin privileges by default
          $arguments = "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/DIR=$testInstallDir", "/LOG=$logFile"
          $process = Start-Process -FilePath $installerFile.FullName -ArgumentList $arguments -PassThru -Wait -NoNewWindow
          
          Write-Host "ðŸ“Š Installer exit code: $($process.ExitCode)"
          
          if ($process.ExitCode -ne 0) {
            Write-Host "âš ï¸  WARNING: Installation may have failed"
            if (Test-Path $logFile) {
              Write-Host ""
              Write-Host "ðŸ“‹ Last 50 lines of installer log:"
              Get-Content $logFile -Tail 50 | Write-Host
            }
          }
          
          # Check if installation directory was created
          Start-Sleep -Seconds 2  # Give the installer time to complete
          
          if (Test-Path $testInstallDir) {
            Write-Host ""
            Write-Host "âœ… Installation directory created"
            
            # List top-level files and directories
            Write-Host ""
            Write-Host "ðŸ“‚ Top-level files and directories:"
            Get-ChildItem -Path $testInstallDir | Format-Table Name, Length, Mode -AutoSize
            
            # Check for essential files
            Write-Host ""
            Write-Host "ðŸ” Checking for essential files..."
            $essentialFiles = @(
              "launcher.bat",
              "pyproject.toml",
              "LICENSE"
            )
            
            $missingCount = 0
            foreach ($file in $essentialFiles) {
              $filePath = Join-Path $testInstallDir $file
              if (Test-Path $filePath) {
                Write-Host "  âœ… Found: $file"
              } else {
                Write-Host "  âŒ Missing: $file"
                $missingCount++
              }
            }
            
            # Clean up test installation
            Write-Host ""
            Write-Host "ðŸ§¹ Cleaning up test installation..."
            Remove-Item -Path $testInstallDir -Recurse -Force -ErrorAction SilentlyContinue
            
            if ($missingCount -eq 0) {
              Write-Host "âœ… Installation test completed successfully"
            } else {
              Write-Host "âŒ ERROR: Installation test failed - $missingCount essential files missing"
              exit 1
            }
          } else {
            Write-Host ""
            Write-Host "âŒ ERROR: Installation directory not found"
            Write-Host "This typically means the installer failed to run or was unable to create the directory."
            
            if ($process.ExitCode -ne 0) {
              Write-Host "Installer exit code: $($process.ExitCode)"
            }
            
            Write-Host "âŒ Installation test failed"
            exit 1
          }
        shell: pwsh
      
      - name: Upload Windows installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: AI-OS-${{ needs.prepare.outputs.version }}-windows-${{ needs.prepare.outputs.short_sha }}-DEV
          path: installers/releases/*.exe
          retention-days: 7
          if-no-files-found: error

  # =============================================================================
  # Summary Report
  # =============================================================================
  summary:
    name: Build Summary
    needs: [prepare, build-deb, build-windows]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸ”§ Dev Installer Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ needs.prepare.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Date:** ${{ needs.prepare.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Debian/Ubuntu | ${{ needs.build-deb.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | ${{ needs.build-windows.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸  **Note:** This is a development build and is NOT published. Artifacts are retained for 7 days." >> $GITHUB_STEP_SUMMARY
