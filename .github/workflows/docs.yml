name: Documentation

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'src/**/*.py'
      - 'README.md'
      - '.github/workflows/docs.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # =============================================================================
  # Build Documentation
  # =============================================================================
  build:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install documentation dependencies
        run: |
          pip install mkdocs mkdocs-material mkdocstrings[python] mkdocs-gen-files mkdocs-literate-nav
      
      - name: Check for mkdocs.yml
        id: check_mkdocs
        run: |
          if [ -f "mkdocs.yml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate mkdocs.yml if missing
        if: steps.check_mkdocs.outputs.exists == 'false'
        run: |
          cat > mkdocs.yml << 'EOF'
          site_name: AI-OS Documentation
          site_description: Autonomous HRM agent with OS integration
          site_url: https://wulfic.github.io/AI-OS/
          repo_url: https://github.com/Wulfic/AI-OS
          repo_name: Wulfic/AI-OS
          
          theme:
            name: material
            palette:
              - media: "(prefers-color-scheme: light)"
                scheme: default
                primary: indigo
                accent: indigo
                toggle:
                  icon: material/brightness-7
                  name: Switch to dark mode
              - media: "(prefers-color-scheme: dark)"
                scheme: slate
                primary: indigo
                accent: indigo
                toggle:
                  icon: material/brightness-4
                  name: Switch to light mode
            features:
              - navigation.instant
              - navigation.tracking
              - navigation.sections
              - navigation.expand
              - navigation.top
              - search.suggest
              - search.highlight
              - content.code.copy
          
          plugins:
            - search
          
          markdown_extensions:
            - pymdownx.highlight:
                anchor_linenums: true
            - pymdownx.superfences
            - pymdownx.tabbed:
                alternate_style: true
            - admonition
            - pymdownx.details
            - toc:
                permalink: true
          
          nav:
            - Home: index.md
            - Guide:
                - Quick Start: guide/QUICK_START.md
                - Index: guide/INDEX.MD
          EOF
      
      - name: Prepare docs structure
        run: |
          # Create index.md from README if it doesn't exist
          mkdir -p docs
          if [ ! -f "docs/index.md" ]; then
            cp README.md docs/index.md
          fi
      
      - name: Build MkDocs site
        run: mkdocs build --strict || mkdocs build
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'site'

  # =============================================================================
  # Deploy to GitHub Pages
  # =============================================================================
  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
