name: Build Installers

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'config/**'
      - 'installers/**'
      - 'pyproject.toml'
      - '.github/workflows/build-installers.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger
    inputs:
      refresh_lock:
        description: 'Refresh requirements-lock.txt'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Short SHA for readable artifact names
  SHORT_SHA: ${{ github.sha }}

jobs:
  # =============================================================================
  # Prepare version info
  # =============================================================================
  prepare:
    name: Prepare Build Info
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      short_sha: ${{ steps.version.outputs.short_sha }}
      build_date: ${{ steps.version.outputs.build_date }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Extract version info
        id: version
        run: |
          VERSION=$(grep -oP 'version\s*=\s*"\K[^"]+' pyproject.toml | head -1)
          SHORT_SHA=${GITHUB_SHA::7}
          BUILD_DATE=$(date +'%Y-%m-%d')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION | SHA: $SHORT_SHA | Date: $BUILD_DATE"

  # =============================================================================
  # Ubuntu/Debian Package Build
  # =============================================================================
  build-deb:
    name: Build Debian Package
    runs-on: ubuntu-22.04
    needs: prepare
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev
      
      - name: Build .deb package
        run: |
          chmod +x ./installers/_builds/ubuntu/build_deb.sh
          if [ "${{ github.event.inputs.refresh_lock }}" == "true" ]; then
            ./installers/_builds/ubuntu/build_deb.sh --refresh-lock
          else
            ./installers/_builds/ubuntu/build_deb.sh
          fi
      
      - name: Upload .deb artifact
        uses: actions/upload-artifact@v5
        with:
          name: AI-OS-${{ needs.prepare.outputs.version }}-ubuntu-${{ needs.prepare.outputs.short_sha }}
          path: installers/releases/*.deb
          retention-days: 30
          if-no-files-found: error

  # =============================================================================
  # Windows Installer Build
  # =============================================================================
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    needs: prepare
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: Install Inno Setup
        run: |
          # Download Inno Setup 6
          $innoUrl = "https://jrsoftware.org/download.php/is.exe"
          $innoInstaller = "$env:TEMP\innosetup.exe"
          
          Write-Host "Downloading Inno Setup..."
          Invoke-WebRequest -Uri $innoUrl -OutFile $innoInstaller -UseBasicParsing
          
          Write-Host "Installing Inno Setup silently..."
          Start-Process -FilePath $innoInstaller -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/SP-" -Wait
          
          # Add to PATH for this session
          $innoPath = "C:\Program Files (x86)\Inno Setup 6"
          echo "$innoPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
          Write-Host "Inno Setup installed successfully"
        shell: pwsh
      
      - name: Build Windows installer
        run: |
          & .\installers\_builds\windows\build_windows_installer.ps1
        shell: pwsh
      
      - name: Upload Windows installer artifact
        uses: actions/upload-artifact@v5
        with:
          name: AI-OS-${{ needs.prepare.outputs.version }}-windows-${{ needs.prepare.outputs.short_sha }}
          path: installers/releases/*.exe
          retention-days: 30
          if-no-files-found: error

  # =============================================================================
  # Release Job (only on tags)
  # =============================================================================
  create-release:
    name: Create Release
    needs: [prepare, build-deb, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.deb
            artifacts/**/*.exe
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
