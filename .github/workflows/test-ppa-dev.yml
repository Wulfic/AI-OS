name: Test PPA Publishing (Dev)

on:
  workflow_dispatch:
    inputs:
      test_ppa:
        description: 'Test PPA publishing workflow'
        required: false
        default: 'true'

jobs:
  # =============================================================================
  # Prepare Build Info
  # =============================================================================
  prepare:
    name: Prepare Build Info
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      short_sha: ${{ steps.get_version.outputs.short_sha }}
      build_date: ${{ steps.get_version.outputs.build_date }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version and metadata
        id: get_version
        run: |
          VERSION=$(grep -oP 'version\s*=\s*"\K[^"]+' pyproject.toml | head -1)
          SHORT_SHA=${GITHUB_SHA::7}
          BUILD_DATE=$(date +'%Y-%m-%d')
          echo "version=$VERSION-dev" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "üîß DEV BUILD | Version: $VERSION-dev | SHA: $SHORT_SHA | Date: $BUILD_DATE"

  # =============================================================================
  # Prepare PPA Source Package (DEV)
  # =============================================================================
  prepare-ppa-dev:
    name: Prepare PPA Source Package (aios-dev)
    runs-on: ubuntu-22.04
    needs: [prepare]
    outputs:
      dsc_file: ${{ steps.build_source.outputs.dsc_file }}
      changes_file: ${{ steps.build_source.outputs.changes_file }}
    
    steps:
      - name: Free up disk space
        run: |
          echo "üßπ Freeing up disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo apt-get autoremove -y
          sudo apt-get clean
          df -h
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Launchpad build tools
        run: |
          echo "üîß Installing Launchpad build dependencies..."
          sudo apt-get update
          sudo apt-get install -y \
            devscripts \
            debhelper \
            dh-python \
            python3-all \
            python3-setuptools \
            dpkg-dev \
            fakeroot \
            lintian \
            dput \
            gnupg2
      
      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.LAUNCHPAD_GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.LAUNCHPAD_GPG_PASSPHRASE }}
        run: |
          echo "üîê Importing GPG key..."
          
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "‚ùå GPG_PRIVATE_KEY secret not set"
            echo "::error title=GPG Key Missing::LAUNCHPAD_GPG_PRIVATE_KEY secret must be configured"
            exit 1
          fi
          
          echo "::add-mask::$GPG_PASSPHRASE"
          echo "$GPG_PRIVATE_KEY" | gpg --batch --quiet --import 2>/dev/null
          
          KEY_ID=$(gpg --list-secret-keys --keyid-format LONG 2>/dev/null | grep sec | awk '{print $2}' | cut -d'/' -f2 | head -1)
          KEY_ID_SHORT=$(echo "$KEY_ID" | tail -c 9)
          echo "key_id=$KEY_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ GPG Key imported (ID: *****$KEY_ID_SHORT)"
          
          if [ -n "$GPG_PASSPHRASE" ]; then
            echo "allow-preset-passphrase" >> ~/.gnupg/gpg-agent.conf
            gpg-connect-agent reloadagent /bye 2>/dev/null || true
          fi
      
      - name: Build source package for PPA
        id: build_source
        env:
          DEBEMAIL: "support@ai-os.invalid"
          DEBFULLNAME: "AI-OS Dev Team"
        run: |
          echo "üì¶ Building source package for PPA..."
          
          VERSION="${{ needs.prepare.outputs.version }}"
          ORIG_VERSION="${VERSION%-dev}"
          PACKAGE_NAME="ai-os"
          BUILD_DIR="${PACKAGE_NAME}-${ORIG_VERSION}"
          
          echo "Version: $VERSION"
          echo "Original version: $ORIG_VERSION"
          echo "Build directory: $BUILD_DIR"
          
          # Create properly named build directory
          mkdir -p "$BUILD_DIR"
          
          # Copy source files excluding build artifacts
          echo "üìÅ Copying source files..."
          rsync -av ./ "$BUILD_DIR/" \
            --exclude=".git" \
            --exclude="build" \
            --exclude="dist" \
            --exclude="*.egg-info" \
            --exclude="__pycache__" \
            --exclude=".venv" \
            --exclude="artifacts" \
            --exclude="${PACKAGE_NAME}-*" \
            --exclude="installers/_builds" \
            --exclude="installers/releases"
          
          # Create debian directory
          mkdir -p "$BUILD_DIR/debian"
          
          # Create debian/control
          printf '%s\n' \
            "Source: $PACKAGE_NAME" \
            'Section: devel' \
            'Priority: optional' \
            'Maintainer: AI-OS Dev Team <support@ai-os.invalid>' \
            'Build-Depends: debhelper-compat (= 12), dh-python, python3-all (>= 3.10), python3-setuptools' \
            'Standards-Version: 4.5.1' \
            'Homepage: https://github.com/Wulfic/AI-OS' \
            '' \
            "Package: $PACKAGE_NAME" \
            'Architecture: all' \
            'Depends: ${python3:Depends}, ${misc:Depends}, python3 (>= 3.10), python3-pip, python3-venv, ffmpeg' \
            'Description: AI Operating System - Recursive Hierarchical Reasoning Models (DEV)' \
            ' AI-OS provides advanced AI models with recursive hierarchical reasoning' \
            ' capabilities, supporting multiple modalities and adaptive learning.' \
            ' .' \
            ' This is a development build from the dev branch.' \
            > "$BUILD_DIR/debian/control"
          
          # Create debian/changelog
          printf '%s\n' \
            "$PACKAGE_NAME ($VERSION-1) unstable; urgency=medium" \
            '' \
            "  * Development build $VERSION" \
            '  * See GitHub commits for changes' \
            '' \
            " -- AI-OS Dev Team <support@ai-os.invalid>  $(date -R)" \
            > "$BUILD_DIR/debian/changelog"
          
          # Create debian/rules
          printf '%s\n' \
            '#!/usr/bin/make -f' \
            '' \
            '%:' \
            '	dh $@ --with python3 --buildsystem=pybuild' \
            > "$BUILD_DIR/debian/rules"
          chmod +x "$BUILD_DIR/debian/rules"
          
          # Create debian/compat
          echo "12" > "$BUILD_DIR/debian/compat"
          
          # Create source tarball (.orig.tar.gz)
          echo "üì¶ Creating original source tarball: ${PACKAGE_NAME}_${ORIG_VERSION}.orig.tar.gz"
          tar --exclude-vcs --exclude="$BUILD_DIR/debian" \
              -czf "${PACKAGE_NAME}_${ORIG_VERSION}.orig.tar.gz" "$BUILD_DIR"
          
          # Verify tarball was created
          if [ ! -f "${PACKAGE_NAME}_${ORIG_VERSION}.orig.tar.gz" ]; then
            echo "‚ùå Failed to create tarball"
            ls -la
            exit 1
          fi
          
          echo "‚úÖ Tarball created: $(ls -lh ${PACKAGE_NAME}_${ORIG_VERSION}.orig.tar.gz)"
          
          # Build source package
          echo "üî® Building source package..."
          cd "$BUILD_DIR"
          debuild -S -sa -us -uc --no-check-builddeps 2>&1 || {
            echo "‚ùå debuild failed"
            exit 1
          }
          cd ..
          
          # Find generated files
          DSC_FILE=$(find . -name "*.dsc" | head -1)
          CHANGES_FILE=$(find . -name "*_source.changes" | head -1)
          
          if [ -z "$DSC_FILE" ] || [ -z "$CHANGES_FILE" ]; then
            echo "‚ùå Source package files not found"
            echo "Files in directory:"
            ls -la
            exit 1
          fi
          
          echo "dsc_file=$DSC_FILE" >> $GITHUB_OUTPUT
          echo "changes_file=$CHANGES_FILE" >> $GITHUB_OUTPUT
          echo "‚úÖ Source package built successfully"
          echo "üì¶ .dsc file: $DSC_FILE"
          echo "üì¶ .changes file: $CHANGES_FILE"
      
      - name: Sign source package
        env:
          GPG_PASSPHRASE: ${{ secrets.LAUNCHPAD_GPG_PASSPHRASE }}
        run: |
          echo "üîè Signing source package..."
          echo "::add-mask::$GPG_PASSPHRASE"
          
          CHANGES_FILE="${{ steps.build_source.outputs.changes_file }}"
          
          if [ -n "$GPG_PASSPHRASE" ]; then
            echo "$GPG_PASSPHRASE" | debsign -p"gpg --batch --yes --quiet --passphrase-fd 0" "$CHANGES_FILE" 2>&1 | grep -v "gpg:\|Good signature" || true
          else
            debsign "$CHANGES_FILE" 2>&1 | grep -v "gpg:\|Good signature" || true
          fi
          
          echo "‚úÖ Package signed successfully"
      
      - name: Validate package with lintian
        run: |
          echo "üîç Validating package..."
          CHANGES_FILE="${{ steps.build_source.outputs.changes_file }}"
          lintian -I -E --pedantic "$CHANGES_FILE" || true
          echo "‚úÖ Validation complete"
      
      - name: Upload PPA source artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ppa-source-package-dev
          path: |
            *.dsc
            *.tar.*
            *.changes
            *.buildinfo
          retention-days: 7

  # =============================================================================
  # Upload to PPA (DEV)
  # =============================================================================
  publish-ppa-dev:
    name: Upload to PPA (aios-dev)
    needs: [prepare, prepare-ppa-dev]
    runs-on: ubuntu-22.04
    
    steps:
      - name: Download source package
        uses: actions/download-artifact@v4
        with:
          name: ppa-source-package-dev
          path: package
      
      - name: Install dput
        run: |
          sudo apt-get update
          sudo apt-get install -y dput gnupg2
      
      - name: Configure dput for Launchpad
        run: |
          mkdir -p ~/.dput.d
          
          printf '%s\n' \
            '[DEFAULT]' \
            'default_host_main = ppa' \
            '' \
            '[ppa]' \
            'fqdn = ppa.launchpad.net' \
            'method = ftp' \
            'incoming = ~%(ppa)s/ubuntu' \
            'login = anonymous' \
            'allow_unsigned_uploads = 0' \
            > ~/.dput.cf
          
          echo "‚úÖ dput configured"
      
      - name: Import GPG key for upload
        env:
          GPG_PRIVATE_KEY: ${{ secrets.LAUNCHPAD_GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.LAUNCHPAD_GPG_PASSPHRASE }}
        run: |
          echo "üîê Importing GPG key for upload..."
          echo "::add-mask::$GPG_PASSPHRASE"
          echo "$GPG_PRIVATE_KEY" | gpg --batch --quiet --import 2>/dev/null
          echo "‚úÖ GPG key ready for signing"
      
      - name: Upload to PPA
        run: |
          echo "üì§ Uploading to ppa:wulfic/aios-dev..."
          
          cd package
          CHANGES_FILE=$(find . -name "*_source.changes" | head -1)
          
          if [ -z "$CHANGES_FILE" ]; then
            echo "‚ùå Source changes file not found"
            exit 1
          fi
          
          dput ppa:wulfic/aios-dev "$CHANGES_FILE"
          
          echo "‚úÖ Package uploaded successfully to ppa:wulfic/aios-dev"

  # =============================================================================
  # Test PPA Installation (DEV)
  # =============================================================================
  test-ppa-install-dev:
    name: Test PPA Installation (aios-dev)
    runs-on: ubuntu-22.04
    needs: [prepare, publish-ppa-dev]
    
    steps:
      - name: Wait for PPA processing
        run: |
          echo "‚è≥ Waiting 5 minutes for PPA to process package..."
          sleep 300
      
      - name: Add PPA and install
        run: |
          echo "üì• Adding ppa:wulfic/aios-dev"
          sudo add-apt-repository -y ppa:wulfic/aios-dev
          sudo apt-get update
          
          echo "üì¶ Installing ai-os from PPA"
          sudo apt-get install -y ai-os
      
      - name: Verify installation
        run: |
          echo "‚úÖ Verifying installation..."
          
          # Check if package is installed
          if dpkg -l | grep -q ai-os; then
            echo "‚úÖ Package installed successfully"
          else
            echo "‚ùå Package not found"
            exit 1
          fi
          
          # Check if files exist
          if [ -d "/opt/ai-os" ]; then
            echo "‚úÖ Found /opt/ai-os"
          else
            echo "‚ùå Missing /opt/ai-os"
            exit 1
          fi
          
          # Try to run aios command
          if command -v aios &> /dev/null; then
            echo "‚úÖ aios command available"
            aios --version || echo "‚ö†Ô∏è  Version check failed but command exists"
          else
            echo "‚ö†Ô∏è  aios command not found in PATH"
          fi
