name: Publish to Launchpad PPA

on:
  workflow_run:
    workflows: ["Test Installers"]
    types:
      - completed
  workflow_dispatch:  # Manual trigger
    inputs:
      ppa_name:
        description: 'PPA name (e.g., ppa:user/ppa-name)'
        required: true
        default: 'ppa:wulfic/ai-os'
      force_upload:
        description: 'Force upload even if version exists'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PPA_NAME: ${{ github.event.inputs.ppa_name || 'ppa:wulfic/ai-os' }}

jobs:
  # =============================================================================
  # Prepare for Launchpad Upload
  # =============================================================================
  prepare-launchpad:
    name: Prepare Launchpad Package
    runs-on: ubuntu-22.04
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Extract version info
        id: version
        run: |
          VERSION=$(grep -oP 'version\s*=\s*"\K[^"]+' pyproject.toml | head -1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $VERSION"
      
      - name: Install Launchpad build tools
        run: |
          echo "üîß Installing Launchpad build dependencies..."
          sudo apt-get update
          sudo apt-get install -y \
            devscripts \
            debhelper \
            dh-python \
            python3-all \
            python3-setuptools \
            dpkg-dev \
            fakeroot \
            lintian \
            dput \
            gnupg2
      
      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.LAUNCHPAD_GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.LAUNCHPAD_GPG_PASSPHRASE }}
        run: |
          echo "üîê Importing GPG key..."
          
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "‚ùå GPG_PRIVATE_KEY secret not set"
            echo "::error title=GPG Key Missing::LAUNCHPAD_GPG_PRIVATE_KEY secret must be configured"
            exit 1
          fi
          
          # Mask sensitive outputs
          echo "::add-mask::$GPG_PASSPHRASE"
          
          # Import GPG key (suppress verbose output)
          echo "$GPG_PRIVATE_KEY" | gpg --batch --quiet --import 2>/dev/null
          
          # Get key ID (last 8 characters only for privacy)
          KEY_ID=$(gpg --list-secret-keys --keyid-format LONG 2>/dev/null | grep sec | awk '{print $2}' | cut -d'/' -f2 | head -1)
          KEY_ID_SHORT=$(echo "$KEY_ID" | tail -c 9)
          echo "key_id=$KEY_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ GPG Key imported (ID: *****$KEY_ID_SHORT)"
          
          # Configure GPG to use passphrase from environment
          if [ -n "$GPG_PASSPHRASE" ]; then
            echo "allow-preset-passphrase" >> ~/.gnupg/gpg-agent.conf
            gpg-connect-agent reloadagent /bye 2>/dev/null || true
          fi
      
      - name: Build source package for Launchpad
        id: build_source
        run: |
          echo "üì¶ Building source package for Launchpad..."
          
          VERSION="${{ steps.version.outputs.version }}"
          BUILD_DIR="build_launchpad"
          
          mkdir -p "$BUILD_DIR"
          cd "$BUILD_DIR"
          
          # Copy source files (excluding build artifacts)
          rsync -av ../ ./ \
            --exclude=".git" \
            --exclude="build" \
            --exclude="dist" \
            --exclude="*.egg-info" \
            --exclude="__pycache__" \
            --exclude=".venv" \
            --exclude="artifacts" \
            --exclude="build_launchpad"
          
          # Create Debian source package
          # This creates .dsc, .tar.xz, and .changes files needed for Launchpad
          cd ..
          
          if [ ! -f "installers/_builds/ubuntu/create_source_package.sh" ]; then
            echo "‚ö†Ô∏è Source package script not found, creating basic structure..."
            
            # Create basic debian package structure
            mkdir -p "$BUILD_DIR/debian"
            
            # Create control file
            printf '%s\n' \
              'Source: aios' \
              'Section: devel' \
              'Priority: optional' \
              'Maintainer: AI-OS Team <contact@example.com>' \
              'Build-Depends: debhelper-compat (= 12), dh-python, python3-all, python3-setuptools' \
              'Standards-Version: 4.5.1' \
              'Homepage: https://github.com/Wulfic/AI-OS' \
              '' \
              'Package: aios' \
              'Architecture: all' \
              'Depends: ${python3:Depends}, ${misc:Depends}, python3-pip' \
              'Description: AI Operating System - Recursive Hierarchical Reasoning Models' \
              ' AI-OS provides advanced AI models with recursive hierarchical reasoning' \
              ' capabilities, supporting multiple modalities and adaptive learning.' \
              > "$BUILD_DIR/debian/control"
            
            # Create changelog
            printf '%s\n' \
              "aios ($VERSION-1) unstable; urgency=medium" \
              '' \
              "  * New upstream release $VERSION" \
              '  * See GitHub releases for full changelog' \
              '' \
              " -- AI-OS Team <contact@example.com>  $(date -R)" \
              > "$BUILD_DIR/debian/changelog"
            
            # Create rules file
            printf '%s\n' \
              '#!/usr/bin/make -f' \
              '' \
              '%:' \
              '	dh $@ --with python3 --buildsystem=pybuild' \
              > "$BUILD_DIR/debian/rules"
            chmod +x "$BUILD_DIR/debian/rules"
            
            # Create compat file
            echo "12" > "$BUILD_DIR/debian/compat"
            
            # Build source package
            cd "$BUILD_DIR"
            debuild -S -sa -us -uc
          else
            chmod +x "./installers/_builds/ubuntu/create_source_package.sh"
            "./installers/_builds/ubuntu/create_source_package.sh"
          fi
          
          # Find the created .dsc file
          DSC_FILE=$(find . -name "*.dsc" | head -1)
          CHANGES_FILE=$(find . -name "*_source.changes" | head -1)
          
          if [ -z "$DSC_FILE" ] || [ -z "$CHANGES_FILE" ]; then
            echo "‚ùå Source package files not found"
            exit 1
          fi
          
          echo "dsc_file=$DSC_FILE" >> $GITHUB_OUTPUT
          echo "changes_file=$CHANGES_FILE" >> $GITHUB_OUTPUT
          echo "‚úÖ Source package built successfully"
      
      - name: Sign source package
        env:
          GPG_PASSPHRASE: ${{ secrets.LAUNCHPAD_GPG_PASSPHRASE }}
        run: |
          echo "üîè Signing source package..."
          
          # Mask passphrase in logs
          echo "::add-mask::$GPG_PASSPHRASE"
          
          CHANGES_FILE="${{ steps.build_source.outputs.changes_file }}"
          
          if [ -z "$CHANGES_FILE" ]; then
            echo "‚ùå Changes file not found"
            exit 1
          fi
          
          # Sign the changes file (suppress verbose output)
          if [ -n "$GPG_PASSPHRASE" ]; then
            echo "$GPG_PASSPHRASE" | debsign -p"gpg --batch --yes --quiet --passphrase-fd 0" "$CHANGES_FILE" 2>&1 | grep -v "gpg:\|Good signature" || true
          else
            debsign "$CHANGES_FILE" 2>&1 | grep -v "gpg:\|Good signature" || true
          fi
          
          echo "‚úÖ Package signed successfully"
      
      - name: Validate package with lintian
        run: |
          echo "üîç Validating package..."
          
          CHANGES_FILE="${{ steps.build_source.outputs.changes_file }}"
          
          # Run lintian to check for common packaging errors
          # --no-tag-display-limit: show all issues
          # -I: show informational messages
          # -E: show errors
          # --pedantic: show all pedantic tags
          lintian -I -E --pedantic "$CHANGES_FILE" || true
          
          echo "‚úÖ Validation complete"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: launchpad-source-package
          path: |
            *.dsc
            *.tar.*
            *.changes
            *.buildinfo
          retention-days: 30

  # =============================================================================
  # Upload to Launchpad PPA
  # =============================================================================
  upload-to-launchpad:
    name: Upload to Launchpad PPA
    needs: prepare-launchpad
    runs-on: ubuntu-22.04
    
    steps:
      - name: Download source package
        uses: actions/download-artifact@v4
        with:
          name: launchpad-source-package
          path: package
      
      - name: Install dput
        run: |
          sudo apt-get update
          sudo apt-get install -y dput
      
      - name: Configure dput for Launchpad
        run: |
          mkdir -p ~/.dput.d
          
          printf '%s\n' \
            '[DEFAULT]' \
            'default_host_main = ppa' \
            '' \
            '[ppa]' \
            'fqdn = ppa.launchpad.net' \
            'method = ftp' \
            'incoming = ~%(ppa)s/ubuntu' \
            'login = anonymous' \
            'allow_unsigned_uploads = 0' \
            > ~/.dput.cf
          
          echo "‚úÖ dput configured"
      
      - name: Import GPG key for upload
        env:
          GPG_PRIVATE_KEY: ${{ secrets.LAUNCHPAD_GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.LAUNCHPAD_GPG_PASSPHRASE }}
        run: |
          echo "üîê Importing GPG key for upload..."
          
          # Mask sensitive data
          echo "::add-mask::$GPG_PASSPHRASE"
          
          # Import key quietly
          echo "$GPG_PRIVATE_KEY" | gpg --batch --quiet --import 2>/dev/null
          
          echo "‚úÖ GPG key ready for signing"
      
      - name: Upload to PPA
        env:
          LAUNCHPAD_PPA: ${{ env.PPA_NAME }}
        run: |
          echo "üì§ Uploading to Launchpad PPA: $LAUNCHPAD_PPA..."
          
          cd package
          CHANGES_FILE=$(find . -name "*_source.changes" | head -1)
          
          if [ -z "$CHANGES_FILE" ]; then
            echo "‚ùå Source changes file not found"
            exit 1
          fi
          
          # Extract PPA path from format: ppa:user/ppa-name
          PPA_PATH=$(echo "$LAUNCHPAD_PPA" | sed 's/ppa://')
          
          # Upload to Launchpad
          # -u: upload without confirmation
          # -f: force upload even if already uploaded
          FORCE_FLAG=""
          if [ "${{ github.event.inputs.force_upload }}" == "true" ]; then
            FORCE_FLAG="-f"
          fi
          
          dput $FORCE_FLAG "ppa:$PPA_PATH" "$CHANGES_FILE"
          
          echo "‚úÖ Package uploaded successfully to $LAUNCHPAD_PPA"
      
      - name: Report upload success
        if: success()
        run: |
          echo "::notice title=Launchpad Upload::Package uploaded successfully to ${{ env.PPA_NAME }} ‚úÖ"
          echo ""
          echo "üìã Next steps:"
          echo "  1. Wait for Launchpad to process the upload (usually 5-15 minutes)"
          echo "  2. Check for build status at: https://launchpad.net/${PPA_NAME#ppa:}/+packages"
          echo "  3. Once built, the package will be available via apt"
          echo ""
          echo "üíæ To install from PPA:"
          echo "  sudo add-apt-repository ${{ env.PPA_NAME }}"
          echo "  sudo apt update"
          echo "  sudo apt install aios"
      
      - name: Report upload failure
        if: failure()
        run: |
          echo "::error title=Launchpad Upload Failed::Failed to upload package to ${{ env.PPA_NAME }} ‚ùå"
          echo ""
          echo "üîç Troubleshooting:"
          echo "  1. Check GPG key is properly configured in secrets"
          echo "  2. Verify PPA name format: ppa:user/ppa-name"
          echo "  3. Ensure package version doesn't already exist in PPA"
          echo "  4. Check Launchpad build logs for errors"
          exit 1

  # =============================================================================
  # Create Release Notes
  # =============================================================================
  update-release-notes:
    name: Update Release Notes
    needs: upload-to-launchpad
    runs-on: ubuntu-latest
    if: github.ref == 'refs/tags/Official' && success()
    
    permissions:
      contents: write
    
    steps:
      - name: Update GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: Official
          append_body: true
          body: |
            
            ---
            
            ## üì¶ Ubuntu/Debian APT Repository
            
            This release is now available via Launchpad PPA:
            
            ```bash
            sudo add-apt-repository ${{ env.PPA_NAME }}
            sudo apt update
            sudo apt install aios
            ```
            
            **Note:** Allow 5-15 minutes after release for PPA build to complete.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
