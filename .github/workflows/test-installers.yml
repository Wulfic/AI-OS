name: Test Installers

on:
  workflow_run:
    workflows: ["Build Installers"]
    types:
      - completed
  workflow_dispatch:  # Manual trigger
    inputs:
      artifact_name:
        description: 'Artifact name pattern to test (e.g., AI-OS-*)'
        required: false
        default: 'AI-OS-*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # Download Build Artifacts
  # =============================================================================
  download-artifacts:
    name: Download Build Artifacts
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    outputs:
      ubuntu_artifact: ${{ steps.find.outputs.ubuntu_artifact }}
      windows_artifact: ${{ steps.find.outputs.windows_artifact }}
    
    steps:
      - name: Download artifacts from build workflow
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          # For workflow_run: downloads artifacts from triggering workflow
          # For workflow_dispatch: downloads latest artifacts
          
      - name: List downloaded artifacts
        run: |
          echo "üì¶ Downloaded artifacts:"
          ls -lR artifacts/
      
      - name: Find installer files
        id: find
        run: |
          # Find Ubuntu .deb file
          UBUNTU_DEB=$(find artifacts/ -name "*.deb" | head -1)
          if [ -n "$UBUNTU_DEB" ]; then
            echo "ubuntu_artifact=$UBUNTU_DEB" >> $GITHUB_OUTPUT
            echo "‚úÖ Found Ubuntu installer: $UBUNTU_DEB"
          else
            echo "‚ùå No Ubuntu .deb file found"
            exit 1
          fi
          
          # Find Windows .exe file
          WINDOWS_EXE=$(find artifacts/ -name "*.exe" | head -1)
          if [ -n "$WINDOWS_EXE" ]; then
            echo "windows_artifact=$WINDOWS_EXE" >> $GITHUB_OUTPUT
            echo "‚úÖ Found Windows installer: $WINDOWS_EXE"
          else
            echo "‚ùå No Windows .exe file found"
            exit 1
          fi
      
      - name: Upload artifacts for test jobs
        uses: actions/upload-artifact@v4
        with:
          name: test-installers
          path: artifacts/
          retention-days: 7

  # =============================================================================
  # Test Ubuntu Installation
  # =============================================================================
  test-ubuntu-install:
    name: Test Ubuntu Installation
    needs: download-artifacts
    runs-on: ubuntu-22.04
    
    strategy:
      matrix:
        # Test on multiple Ubuntu versions
        ubuntu_version: ['22.04', '20.04']
    
    steps:
      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-installers
          path: installers
      
      - name: Find .deb package
        id: find_deb
        run: |
          DEB_FILE=$(find installers/ -name "*.deb" | head -1)
          if [ -z "$DEB_FILE" ]; then
            echo "‚ùå No .deb file found"
            exit 1
          fi
          echo "deb_file=$DEB_FILE" >> $GITHUB_OUTPUT
          echo "üì¶ Found .deb: $DEB_FILE"
      
      - name: Install .deb package
        run: |
          echo "üîß Installing AI-OS..."
          sudo dpkg -i "${{ steps.find_deb.outputs.deb_file }}" || true
          
          # Fix dependencies if needed
          echo "üì¶ Fixing dependencies..."
          sudo apt-get update
          sudo apt-get install -f -y
      
      - name: Verify installation
        run: |
          echo "‚úÖ Verifying installation..."
          
          # Check if aios command exists
          if command -v aios &> /dev/null; then
            echo "‚úÖ aios command found"
          else
            echo "‚ùå aios command not found"
            exit 1
          fi
          
          # Try running aios --help
          if aios --help &> /dev/null; then
            echo "‚úÖ aios --help works"
          else
            echo "‚ùå aios --help failed"
            exit 1
          fi
          
          # Check version
          echo "üìã AI-OS version:"
          aios --version || echo "‚ö†Ô∏è Version command not available"
          
          echo "‚úÖ Ubuntu installation test passed!"
      
      - name: Test basic functionality
        run: |
          echo "üß™ Testing basic functionality..."
          
          # Test status command
          if aios status; then
            echo "‚úÖ aios status works"
          else
            echo "‚ö†Ô∏è aios status failed (may be expected on CI)"
          fi
      
      - name: Report installation success
        if: success()
        run: |
          echo "::notice title=Ubuntu ${{ matrix.ubuntu_version }}::Installation test passed ‚úÖ"
      
      - name: Report installation failure
        if: failure()
        run: |
          echo "::error title=Ubuntu ${{ matrix.ubuntu_version }}::Installation test failed ‚ùå"
          echo "üìã System info:"
          uname -a
          lsb_release -a
          exit 1

  # =============================================================================
  # Test Windows Installation
  # =============================================================================
  test-windows-install:
    name: Test Windows Installation
    needs: download-artifacts
    runs-on: windows-latest
    
    steps:
      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-installers
          path: installers
      
      - name: Find installer executable
        id: find_exe
        shell: pwsh
        run: |
          $exeFile = Get-ChildItem -Path installers\ -Filter *.exe -Recurse | Select-Object -First 1
          if (-not $exeFile) {
            Write-Host "‚ùå No .exe file found"
            exit 1
          }
          $exePath = $exeFile.FullName
          Write-Host "exe_file=$exePath" >> $env:GITHUB_OUTPUT
          Write-Host "üì¶ Found installer: $exePath"
      
      - name: Install AI-OS
        shell: pwsh
        run: |
          Write-Host "üîß Installing AI-OS..."
          
          $installerPath = "${{ steps.find_exe.outputs.exe_file }}"
          
          # Run installer silently
          # Inno Setup silent install parameters:
          # /VERYSILENT - no dialogs
          # /SUPPRESSMSGBOXES - suppress message boxes
          # /NORESTART - don't restart
          # /SP- - disable "This will install..." prompt
          
          Write-Host "Running installer: $installerPath"
          $process = Start-Process -FilePath $installerPath -ArgumentList '/VERYSILENT', '/SUPPRESSMSGBOXES', '/NORESTART', '/SP-' -Wait -PassThru
          
          if ($process.ExitCode -ne 0) {
            Write-Host "‚ùå Installer exited with code: $($process.ExitCode)"
            exit 1
          }
          
          Write-Host "‚úÖ Installer completed successfully"
      
      - name: Verify installation
        shell: pwsh
        run: |
          Write-Host "‚úÖ Verifying installation..."
          
          # Check if AI-OS is installed in Program Files
          $installPath = "C:\Program Files\AI-OS"
          if (Test-Path $installPath) {
            Write-Host "‚úÖ AI-OS directory found: $installPath"
          } else {
            Write-Host "‚ùå AI-OS directory not found"
            exit 1
          }
          
          # Check if aios executable exists
          $aiosExe = "$installPath\aios.exe"
          if (Test-Path $aiosExe) {
            Write-Host "‚úÖ aios.exe found"
          } else {
            Write-Host "‚ùå aios.exe not found"
            exit 1
          }
          
          # Add to PATH temporarily for testing
          $env:PATH = "$installPath;$env:PATH"
          
          # Try running aios --help
          try {
            & $aiosExe --help | Out-Null
            Write-Host "‚úÖ aios --help works"
          } catch {
            Write-Host "‚ùå aios --help failed: $_"
            exit 1
          }
          
          # Check version
          Write-Host "üìã AI-OS version:"
          try {
            & $aiosExe --version
          } catch {
            Write-Host "‚ö†Ô∏è Version command not available"
          }
          
          Write-Host "‚úÖ Windows installation test passed!"
      
      - name: Test basic functionality
        shell: pwsh
        run: |
          Write-Host "üß™ Testing basic functionality..."
          
          $installPath = "C:\Program Files\AI-OS"
          $aiosExe = "$installPath\aios.exe"
          
          # Test status command
          try {
            & $aiosExe status | Out-Null
            Write-Host "‚úÖ aios status works"
          } catch {
            Write-Host "‚ö†Ô∏è aios status failed (may be expected on CI)"
          }
      
      - name: Report installation success
        if: success()
        shell: pwsh
        run: |
          Write-Host "::notice title=Windows::Installation test passed ‚úÖ"
      
      - name: Report installation failure
        if: failure()
        shell: pwsh
        run: |
          Write-Host "::error title=Windows::Installation test failed ‚ùå"
          Write-Host "üìã System info:"
          systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
          exit 1

  # =============================================================================
  # Report Results
  # =============================================================================
  report-results:
    name: Report Test Results
    needs: [test-ubuntu-install, test-windows-install]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check test results
        run: |
          UBUNTU_STATUS="${{ needs.test-ubuntu-install.result }}"
          WINDOWS_STATUS="${{ needs.test-windows-install.result }}"
          
          echo "üìä Installation Test Results:"
          echo "  Ubuntu: $UBUNTU_STATUS"
          echo "  Windows: $WINDOWS_STATUS"
          
          if [ "$UBUNTU_STATUS" == "success" ] && [ "$WINDOWS_STATUS" == "success" ]; then
            echo "‚úÖ All installation tests passed!"
            echo "::notice title=Test Results::All installation tests passed ‚úÖ"
            exit 0
          else
            echo "‚ùå Some installation tests failed"
            echo "::error title=Test Results::Some installation tests failed ‚ùå"
            exit 1
          fi
      
      - name: Comment on PR (if applicable)
        if: github.event_name == 'workflow_run' && github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const ubuntu = '${{ needs.test-ubuntu-install.result }}';
            const windows = '${{ needs.test-windows-install.result }}';
            
            const ubuntuIcon = ubuntu === 'success' ? '‚úÖ' : '‚ùå';
            const windowsIcon = windows === 'success' ? '‚úÖ' : '‚ùå';
            
            const body = `## üß™ Installation Test Results
            
            | Platform | Status |
            |----------|--------|
            | Ubuntu 22.04/20.04 | ${ubuntuIcon} ${ubuntu} |
            | Windows Latest | ${windowsIcon} ${windows} |
            
            ${ubuntu === 'success' && windows === 'success' ? 
              '‚úÖ All installation tests passed!' : 
              '‚ùå Some tests failed. Check the workflow logs for details.'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: body
            });

  # =============================================================================
  # Publish to Release (only on tag Official)
  # =============================================================================
  publish-to-release:
    name: Publish Tested Installers
    needs: [test-ubuntu-install, test-windows-install]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/tags/Official' && success()
    
    permissions:
      contents: write
    
    steps:
      - name: Download tested artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-installers
          path: release-artifacts
      
      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: Official
          files: |
            release-artifacts/**/*.deb
            release-artifacts/**/*.exe
          body: |
            ‚úÖ **Installation Verified**
            
            These installers have been tested on:
            - Ubuntu 22.04 / 20.04
            - Windows Latest
            
            All tests passed successfully.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
